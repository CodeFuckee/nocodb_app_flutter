name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Weekly build (Every Sunday at 00:00 UTC)

permissions:
  contents: write

jobs:
  # Job 1: Auto-increment version and create tag (Runs on Schedule or Manual Dispatch on branch)
  bump-version:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/')) }}
    outputs:
      new_tag: ${{ steps.create_tag.outputs.tag_name }}
      skipped: ${{ steps.check.outputs.skipped }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Required to check tags

      - name: Check for changes
        id: check
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            git fetch --tags
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$LATEST_TAG" ]; then
              echo "Latest tag found: $LATEST_TAG"
              HEAD_COMMIT=$(git rev-parse HEAD)
              TAG_COMMIT=$(git rev-parse "$LATEST_TAG")
              if [ "$HEAD_COMMIT" == "$TAG_COMMIT" ]; then
                echo "No new commits since $LATEST_TAG. Skipping."
                echo "skipped=true" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "New commits found since $LATEST_TAG. Proceeding."
              fi
            else
              echo "No tags found. This is the first release. Proceeding."
            fi
          fi
          echo "skipped=false" >> $GITHUB_OUTPUT

      - name: Increment Version in pubspec.yaml
        id: increment
        if: steps.check.outputs.skipped != 'true'
        run: |
          # Read current version
          current_version=$(grep '^version: ' pubspec.yaml | sed 's/version: //')
          echo "Current version: $current_version"
          
          # Use python to increment patch and build number
          python3 -c "
          import re
          import sys
          
          v_str = '$current_version'.strip()
          # Regex to capture major.minor.patch+build
          # Matches 1.0.1+2
          m = re.match(r'(\d+)\.(\d+)\.(\d+)\+(\d+)', v_str)
          if m:
              major, minor, patch, build = map(int, m.groups())
              patch += 1
              build += 1
              new_version = f'{major}.{minor}.{patch}+1'
              print(new_version)
          else:
              # Fallback: if no build number, just increment patch and add +1
              m2 = re.match(r'(\d+)\.(\d+)\.(\d+)', v_str)
              if m2:
                  major, minor, patch = map(int, m2.groups())
                  patch += 1
                  new_version = f'{major}.{minor}.{patch}+1'
                  print(new_version)
              else:
                  print('ERROR')
          " > new_version.txt
          
          NEW_VERSION=$(cat new_version.txt)
          if [ "$NEW_VERSION" == "ERROR" ]; then
              echo "Error: Could not parse or increment version '$current_version'"
              exit 1
          fi
          
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $NEW_VERSION/" pubspec.yaml

      - name: Commit and Push
        if: steps.check.outputs.skipped != 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add pubspec.yaml
          git commit -m "Bump version to ${{ steps.increment.outputs.version }}"
          git push origin HEAD
          
      - name: Create and Push Tag
        id: create_tag
        if: steps.check.outputs.skipped != 'true'
        run: |
          TAG_NAME="v${{ steps.increment.outputs.version }}"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

  # Job 2: Build and Release (Runs when a tag is pushed OR after bump-version succeeds)
  build-release:
    runs-on: ubuntu-latest
    needs: bump-version
    # Run if bump-version succeeded AND wasn't skipped, OR if this is a tag push
    if: ${{ always() && ( (needs.bump-version.result == 'success' && needs.bump-version.outputs.skipped != 'true') || (needs.bump-version.result == 'skipped' && startsWith(github.ref, 'refs/tags/v')) ) }}
    steps:
      - name: Determine Tag and Ref
        id: context
        run: |
          if [ "${{ needs.bump-version.result }}" == "success" ] && [ "${{ needs.bump-version.outputs.skipped }}" != "true" ]; then
            echo "tag_name=${{ needs.bump-version.outputs.new_tag }}" >> $GITHUB_OUTPUT
            echo "ref_name=${{ needs.bump-version.outputs.new_tag }}" >> $GITHUB_OUTPUT
          else
            # Tag push trigger
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "ref_name=${GITHUB_REF}" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.context.outputs.ref_name }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Decode Keystore and Create key.properties
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          echo "storePassword=$ANDROID_STORE_PASSWORD" > android/key.properties
          echo "keyPassword=$ANDROID_KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$ANDROID_KEY_ALIAS" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties
          echo "===== key.properties ====="
          cat android/key.properties
          echo "===== upload-keystore.jks sha256 ====="
          sha256sum android/app/upload-keystore.jks

      - name: Get Dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.context.outputs.tag_name }}
          files: build/app/outputs/flutter-apk/app-release.apk
          generate_release_notes: true
